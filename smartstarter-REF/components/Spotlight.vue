<template>
    <main class="relative bg-gray-50 pb-20 px-4 sm:px-6 lg:pb-28 lg:px-8">
        <div class="absolute inset-0">
            <div class="bg-white h-1/3 sm:h-2/3"></div>
        </div>

        <div class="relative max-w-7xl mx-auto">
            <div class="text-center">
                <h2 class="text-5xl tracking-tight font-extrabold text-gray-900 sm:text-6xl">
                    SPOTLIGHT
                </h2>

                <p class="hidden mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
                    We are proud to feature the 3 campaigns that have received the most love from our generous <a class="text-red-500 font-medium" href="https://pif.cash" target="_blank">Pay It Forward (PIF) community</a>.
                </p>
            </div>

            <div class="mt-12 max-w-lg mx-auto grid gap-5 lg:grid-cols-3 lg:max-w-none">

                <router-link to="/flipstarter" class="flex flex-col rounded-lg shadow-lg overflow-hidden">
                    <div class="flex-shrink-0">
                        <img class="h-48 w-full object-cover" src="https://images.unsplash.com/photo-1496128858413-b36217c2ce36?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1679&q=80" alt="" />
                    </div>

                    <div class="flex-1 bg-white p-6 flex flex-col justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-indigo-600">
                                <a href="javascript://" class="hover:underline">
                                    Article
                                </a>
                            </p>

                            <a href="javascript://" class="block mt-2">
                                <p class="text-xl font-semibold text-gray-900">
                                    Boost your conversion rate
                                </p>

                                <p class="mt-3 text-base text-gray-500">
                                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Architecto accusantium praesentium eius, ut atque fuga culpa, similique sequi cum eos quis dolorum.
                                </p>
                            </a>
                        </div>

                        <div class="mt-6 flex items-center">
                            <div class="flex-shrink-0">
                                <a href="javascript://">
                                    <span class="sr-only">Roel Aufderehar</span>
                                    <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="" />
                                </a>
                            </div>

                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">
                                    <a href="javascript://" class="hover:underline">
                                        Roel Aufderehar
                                    </a>
                                </p>

                                <div class="flex space-x-1 text-sm text-gray-500">
                                    <time datetime="2020-03-16">
                                        Mar 16, 2020
                                    </time>

                                    <span aria-hidden="true">
                                        &middot;
                                    </span>

                                    <span>
                                        6 min read
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </router-link>

                <div class="flex flex-col rounded-lg shadow-lg overflow-hidden">
                    <div class="flex-shrink-0">
                        <img class="h-48 w-full object-cover" src="https://images.unsplash.com/photo-1547586696-ea22b4d4235d?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1679&q=80" alt="" />
                    </div>

                    <div class="flex-1 bg-white p-6 flex flex-col justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-indigo-600">
                                <a href="javascript://" class="hover:underline">
                                    Video
                                </a>
                            </p>

                            <a href="javascript://" class="block mt-2">
                                <p class="text-xl font-semibold text-gray-900">
                                    How to use search engine optimization to drive sales
                                </p>

                                <p class="mt-3 text-base text-gray-500">
                                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Velit facilis asperiores porro quaerat doloribus, eveniet dolore. Adipisci tempora aut inventore optio animi., tempore temporibus quo laudantium.
                                </p>
                            </a>
                        </div>

                        <div class="mt-6 flex items-center">
                            <div class="flex-shrink-0">
                                <a href="javascript://">
                                    <span class="sr-only">Brenna Goyette</span>
                                    <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1550525811-e5869dd03032?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="" />
                                </a>
                            </div>

                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">
                                    <a href="javascript://" class="hover:underline">
                                        Brenna Goyette
                                    </a>
                                </p>

                                <div class="flex space-x-1 text-sm text-gray-500">
                                    <time datetime="2020-03-10">
                                        Mar 10, 2020
                                    </time>

                                    <span aria-hidden="true">
                                        &middot;
                                    </span>

                                    <span>
                                        4 min read
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col rounded-lg shadow-lg overflow-hidden">
                    <div class="flex-shrink-0">
                        <img class="h-48 w-full object-cover" src="https://images.unsplash.com/photo-1492724441997-5dc865305da7?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1679&q=80" alt="" />
                    </div>

                    <div class="flex-1 bg-white p-6 flex flex-col justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-indigo-600">
                                <a href="javascript://" class="hover:underline">
                                    Case Study
                                </a>
                            </p>

                            <a href="javascript://" class="block mt-2">
                                <p class="text-xl font-semibold text-gray-900">
                                    Improve your customer experience
                                </p>

                                <p class="mt-3 text-base text-gray-500">
                                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Sint harum rerum voluptatem quo recusandae magni placeat saepe molestiae, sed excepturi cumque corporis perferendis hic.
                                </p>
                            </a>
                        </div>

                        <div class="mt-6 flex items-center">
                            <div class="flex-shrink-0">
                                <a href="javascript://">
                                    <span class="sr-only">Daniela Metz</span>
                                    <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="" />
                                </a>
                            </div>

                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">
                                    <a href="javascript://" class="hover:underline">
                                        Daniela Metz
                                    </a>
                                </p>

                                <div class="flex space-x-1 text-sm text-gray-500">
                                    <time datetime="2020-02-12">
                                        Feb 12, 2020
                                    </time>

                                    <span aria-hidden="true">
                                        &middot;
                                    </span>

                                    <span>
                                        11 min read
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-20 flex justify-center">
                <a href="https://smartbch.builders" target="_blank" class="rounded-xl py-5 px-10 border-4 text-xl sm:text-2xl font-bold text-yellow-700 bg-yellow-200 border-yellow-400 hover:text-yellow-50 hover:bg-yellow-400 hover:border-yellow-200">
                    Open SmartBCH BUIDLers
                </a>
            </div>
        </div>
    </main>
</template>

<script>
/* global BigInt */

/* Import modules. */
import { ethers } from 'ethers'

/* Import components. */
// import HelloWorld from '@/components/HelloWorld.vue'

/* Set constants. */
const TESTNET_PROVIDER = 'https://moeing.tech:9545'

export default {
    components: {
        // HelloWorld
    },
    data: () => {
        return {
            //
        }
    },
    methods: {
        /**
         * Initialization
         */
        async init() {
            /* Initialize provider. */
            const provider = new ethers.providers
                .JsonRpcProvider(TESTNET_PROVIDER)

            /* Set ABI. */
            const abi = this.$store.getters.getCampaignAbi

            /* Set interface. */
            const iface = new ethers.utils.Interface(abi)

            /* Set from block. */
            // TODO: Restrict to the last 90 days.
            // const fromBlock = 0
            const fromBlock = 3730247

            /* Set to block. */
            const toBlock = 'latest'

            /* Set topics. */
            const topics = [
                // SmartstarterCreated
                '0xd88dc5dd1e46152fecce681e8ef1affa28b0a06534b296438edaf3b700f5c590',
            ]

            /**
             * Retrieve Logs
             *
             * Will query the blockchain for logs related to our campaign.
             */
            const logs = await provider.getLogs({
                fromBlock,
                toBlock,
                topics,
            }).catch(err => console.error(err))
            // console.log('LOGS', logs)

            /* Handle logs. */
            logs.forEach(_log => {
                // console.log('LOG', _log)

                try {
                    /* Decode event log. */
                    const decoded = iface
                        .decodeEventLog('SmartstarterCreated', _log.data)

                    /* Set created parameters. */
                    const created = {
                        address: _log.address,
                        blockNumber: _log.blockNumber,

                        owner: _log.topics[1],
                        category: _log.topics[2],

                        domain: decoded.domain,
                        title: decoded.title,
                        summary: decoded.summary,
                        description: decoded.description,
                        banner: decoded.banner,
                        starting: decoded.starting,
                        expiration: decoded.expiration,
                        fundingGoal: decoded.fundingGoal,
                        pledgeBalance: decoded.pledgeBalance,
                        currentState: decoded.currentState,
                        isPublished: decoded.isPublished,
                    }
                    // console.log('CAMPAIGN', campaign)

                    /* Add new campaign. */
                    // NOTE: Added to the beginning array to put the most
                    //       recent entries first.
                    this.created.unshift(created)
                } catch (err) {
                    console.error('There was an error parsing the log', err)
                }
            })
            console.log('CREATED', this.created)

            this.loadCreated()

        },

        loadCreated() {
            /* Validate campaigns. */
            if (this.created.length === 0) return

            /* Handle campaigns. */
            this.created.forEach(_created => {
                // console.log('LOADING CREATED', _created)

                if (!this.processed.includes(_created.address)) {
                    this.processed.push(_created.address)

                    /* Add a featured campaign. */
                    this.addCampaign(_created)
                }
            })
        },

        async addCampaign(_campaign) {
            console.log('Adding', _campaign.address)

            /* Initialize provider. */
            const provider = new ethers.providers
                .JsonRpcProvider(this.$store.getters.getProvider)
            // console.log('PROVIDER', provider)

            this.blockNum = await provider
                .getBlockNumber()
                .catch(err => console.error(err))
            // console.log('BLOCK NUM', this.blockNum)

            /* Set Campaign ABI. */
            const abi = this.$store.getters.getCampaignAbi

            /* Set campaign address. */
            const address = _campaign.address

            /* Initialize campaign instance. */
            const contract = new ethers.Contract(address, abi, provider)
            // console.log('CONTRACT (campaign):', campaign)

            /* Request campaign info. */
            const campaignInfo = await contract
                .getCampaign()
                .catch(err => console.error(err))
            console.log('CAMPAIGN (info):', campaignInfo)

            /* Build campaign package. */
            const campaign = {
                address,
                owner: campaignInfo.owner,
                title: campaignInfo.title,
                summary: campaignInfo.summary,
                starting: Number(campaignInfo.starting),
                expiration: Number(campaignInfo.expiration),
                fundingGoal: BigInt(campaignInfo.fundingGoal),
                pledgeBalance: BigInt(campaignInfo.pledgeBalance),
                currentState: campaignInfo.currentState,
                isPublished: campaignInfo.isPublished,
            }

            /* Request campaign info. */
            const campaignDetails = await contract
                .getCampaignDetails()
                .catch(err => console.error(err))
            console.log('CAMPAIGN (details):', campaignDetails)

            /* Validate campaign details. */
            if (campaignDetails) {
                /* Set category. */
                campaign.category = this.$store.getters.getCategoryById(
                    campaignDetails.category)

                /* Set domain. */
                campaign.domain = campaignDetails.domain

                /* Set description. */
                campaign.description = campaignDetails.description

                /* Set banner. */
                campaign.banner = campaignDetails.banner

                /* Set highlights. */
                campaign.highlights = campaignDetails.highlights
            }

            console.log('CAMPAIGN', campaign)

            /* Add campaign. */
            this.campaigns.push(campaign)

        },

        /**
         * Find Featured
         *
         * Will parse ALL campaigns to determine which should be listed as
         * featured and showcased on the platform.
         */
        findFeatured() {
            /* Initialized holders. */
            // let bannered = []
            let featured = []

            // FIXME: We need to turn this off after a reasonable period of time
            //        to load ALL featured campaigns.
            setInterval(() => {
                if (!this.campaigns || this.campaigns.length === 0) return

                /* Clear holders. */
                // bannered = []
                featured = []

                /* Handle bannered. */
                for (let i = 0; i < this.campaigns.length; i++) {
                    /* Set campaign. */
                    const campaign = this.campaigns[i]

                    if (campaign.banner) {
                        // bannered.push(campaign)
                        featured.push(campaign)
                    }
                }

                /* Clear featured (instance). */
                this.featured = []

                /* Handle featured. */
                for (let j = 0; j < featured.length; j++) {
                    /* Limit to TOP3. */
                    if (j === 3) break

                    /* Set campaign. */
                    const campaign = featured[j]

                    this.featured.push(campaign)
                }
            }, 500)
        },

    },
    created: function () {
        //
    },
    mounted: function () {
        //
    },
}
</script>
